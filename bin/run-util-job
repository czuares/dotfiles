#!/usr/bin/env bash

set -euo pipefail
declare jobname

# trap cleanup EXIT

function cleanup() {
    kubectl delete job "$jobname"
}
function main() {
    : "${1?Service name is required}"
    : "${2?Command is required}"

    export SERVICE="$1"

    jobname="${SERVICE}-util-job"
    envsubst < ~/bin/util-job.yaml | kubectl apply -f -
    sleep 3 

    local pod
    pod=$(kubectl get pod -l job-name="$jobname" --no-headers -o custom-columns=:metadata.name | head -n 1)

    kubectl exec -it "$pod" "${@:2}"

    # kubectl delete job "$jobname"
}

main "$@"
