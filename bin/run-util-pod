#!/usr/bin/env bash

set -euo pipefail
declare podname

# trap cleanup EXIT

function cleanup() {
    kubectl delete job "$podname"
}
function main() {
    : "${1?Service name is required}"
    : "${2?Command is required}"

    export SERVICE="$1"

    podname="${SERVICE}-util-pod"
    envsubst < ~/bin/util-pod.yaml | kubectl apply -f -
    sleep 10

    local pod
    pod=$(kubectl get pod -l app="$podname" --no-headers -o custom-columns=:metadata.name | head -n 1)

    kubectl exec -it "$pod" "${@:2}"

    kubectl delete pod "$podname"
}

main "$@"
