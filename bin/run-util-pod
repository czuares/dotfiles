#!/usr/bin/env bash

set -euo pipefail

function main() {
    : "${1?Service name is required}"
    : "${2?Command is required}"

    export SERVICE="$1"
    IMAGE="$(kubectl get deploy -l app="$SERVICE" -o jsonpath='{.items[0].spec.template.spec.containers[0].image}')"
    export IMAGE 
    podname="${SERVICE}-util-pod"
    envsubst < ~/bin/util-pod.yaml | kubectl apply -f -
    sleep 10

    local pod
    pod=$(kubectl get pod -l app="$podname" --no-headers -o custom-columns=:metadata.name | head -n 1)

    kubectl exec -it "$pod" "${@:2}"

    read -rp "Would you like to delete the pod [y/N]?"
    echo
    if [[ $REPLY =~ ^[Yy] ]]; then
        kubectl delete pod "$podname"
    fi
}

main "$@"
